{
  "hash": "5095d36d3d48b29cc6a9fee6a24b6a46",
  "result": {
    "markdown": "---\ntitle: \"Projecting portfolio risk\"\ndate: \"2023-05-20\"\ncategories: [investment, risk]\ncode-fold: false\ncode-summary: \"</>\"\ndf-print: paged\nimage: \"sectorRisk.png\"\ndescription: \"Risk analysis is a standard technique within quantitative investment. In this post, I'll describe how to perform it succinctly in R.\"\n---\n\n\nTo do so, I'll deliberately pick a minimal example and assume that our portfolio has the thirty-stock Dow-Jones Industrial Average (DJIA) as its index.\n\nI'll show the results in a couple of paragraphs. Before that, let's consider a little of [the theory](https://en.wikipedia.org/wiki/Tracking_error) behind this analysis. Specifically, that the active variance of a portfolio relative to its index is: $$\\omega^2 = X^T V X$$\n\n, where:\n\n-   X is a vector of 'excess weights' for the thirty stocks (i.e. portfolio weight less index weight)\n\n-   V is a square matrix of the covariances between the returns of the thirty stocks\n\nGiven this equation, I see that I need to begin the analysis by downloading the holdings of the index and the pricing data for the constituent stocks.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(reactable)\nlibrary(tidyquant)\nlibrary(tidyverse)\nlibrary(tsibble)\nlibrary(waldo)\n\n# weights_index <- tq_index(\"DOW\")\n# write_rds(x = weights_index, file = \"weights_index.rds\")\n\n# stock_prices  <- tq_get(\n#   x = weights_index |> pull(symbol), \n#   get = \"stock.prices\", \n#   from = \"2022-01-01\")\n# write_rds(x = stock_prices, file = \"stock_prices.rds\", compress = \"xz\")\n```\n:::\n\n\n<br/>\n\n#### Stock holdings\n\nWith this data, I can see that the DJIA has the following stocks. For the sake of simplicity, I assume that these thirty stocks are weighted equally in our portfolio.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_weights <- read_rds(\"weights_index.rds\") |> \n  mutate(\n    wt_port = 1/30,\n    wt_excess = wt_port - weight) |> \n  arrange(symbol)\n\ndata_weights |> \n  select(company, symbol, `excess weight` = wt_excess)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"company\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"symbol\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"excess weight\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"Apple Inc.\",\"2\":\"AAPL\",\"3\":\"-0.0007798357\"},{\"1\":\"Amgen Inc.\",\"2\":\"AMGN\",\"3\":\"-0.0126822422\"},{\"1\":\"American Express Company\",\"2\":\"AXP\",\"3\":\"0.0041094822\"},{\"1\":\"Boeing Company\",\"2\":\"BA\",\"3\":\"-0.0061428505\"},{\"1\":\"Caterpillar Inc.\",\"2\":\"CAT\",\"3\":\"-0.0085663682\"},{\"1\":\"Salesforce Inc.\",\"2\":\"CRM\",\"3\":\"-0.0069310353\"},{\"1\":\"Cisco Systems Inc.\",\"2\":\"CSCO\",\"3\":\"0.0241522315\"},{\"1\":\"Chevron Corporation\",\"2\":\"CVX\",\"3\":\"0.0024564583\"},{\"1\":\"Walt Disney Company\",\"2\":\"DIS\",\"3\":\"0.0134537234\"},{\"1\":\"Dow Inc.\",\"2\":\"DOW\",\"3\":\"0.0228274462\"},{\"1\":\"Goldman Sachs Group Inc.\",\"2\":\"GS\",\"3\":\"-0.0300656003\"},{\"1\":\"Home Depot Inc.\",\"2\":\"HD\",\"3\":\"-0.0234770658\"},{\"1\":\"Honeywell International Inc.\",\"2\":\"HON\",\"3\":\"-0.0054549014\"},{\"1\":\"International Business Machines Corporation\",\"2\":\"IBM\",\"3\":\"0.0093496501\"},{\"1\":\"Intel Corporation\",\"2\":\"INTC\",\"3\":\"0.0274425685\"},{\"1\":\"Johnson & Johnson\",\"2\":\"JNJ\",\"3\":\"0.0015601573\"},{\"1\":\"JPMorgan Chase & Co.\",\"2\":\"JPM\",\"3\":\"0.0065074586\"},{\"1\":\"Coca-Cola Company\",\"2\":\"KO\",\"3\":\"0.0208520639\"},{\"1\":\"McDonald's Corporation\",\"2\":\"MCD\",\"3\":\"-0.0249590900\"},{\"1\":\"3M Company\",\"2\":\"MMM\",\"3\":\"0.0135008961\"},{\"1\":\"Merck & Co. Inc.\",\"2\":\"MRK\",\"3\":\"0.0101594561\"},{\"1\":\"Microsoft Corporation\",\"2\":\"MSFT\",\"3\":\"-0.0280528759\"},{\"1\":\"NIKE Inc. Class B\",\"2\":\"NKE\",\"3\":\"0.0090567835\"},{\"1\":\"Procter & Gamble Company\",\"2\":\"PG\",\"3\":\"0.0030579125\"},{\"1\":\"Travelers Companies Inc.\",\"2\":\"TRV\",\"3\":\"-0.0026677530\"},{\"1\":\"UnitedHealth Group Incorporated\",\"2\":\"UNH\",\"3\":\"-0.0629925518\"},{\"1\":\"Visa Inc. Class A\",\"2\":\"V\",\"3\":\"-0.0121240305\"},{\"1\":\"Verizon Communications Inc.\",\"2\":\"VZ\",\"3\":\"0.0259369529\"},{\"1\":\"Walgreens Boots Alliance Inc.\",\"2\":\"WBA\",\"3\":\"0.0271241504\"},{\"1\":\"Walmart Inc.\",\"2\":\"WMT\",\"3\":\"0.0033488090\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n<br/>\n\n#### Return covariances\n\nBefore I can project the risk in this portfolio, though, I also need to find the covariances between the returns of the stocks in question.[^1]\n\n[^1]: For the sake of simplicity, I only consider split-adjusted price returns rather than the equivalent total returns in this example\n\nFor the sake of brevity, here are the first four rows and columns of this covariance matrix.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nreturn_covariances <- read_rds(file = \"stock_prices.rds\") |>\n  as_tsibble(index = date, key = symbol) |> \n  mutate(yyyymm = tsibble::yearmonth(date)) |> \n  slice_max(order_by = date, by = yyyymm) |> \n  as_tsibble(index = date, key = symbol) |> \n  mutate(return = (adjusted/lag(adjusted)) - 1) |> \n  pivot_wider(id_cols = date, names_from = symbol, values_from = return) |> \n  column_to_rownames(var = \"date\") |> \n  cov(use = \"pairwise.complete.obs\")\n\nas_tibble(return_covariances[1:4, 1:4])\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"AAPL\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"AMGN\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"AXP\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"BA\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"0.008828210\",\"2\":\"0.002962460\",\"3\":\"0.005350393\",\"4\":\"0.006616771\"},{\"1\":\"0.002962460\",\"2\":\"0.009017254\",\"3\":\"-0.001116983\",\"4\":\"0.008412490\"},{\"1\":\"0.005350393\",\"2\":\"-0.001116983\",\"3\":\"0.011592201\",\"4\":\"0.002442701\"},{\"1\":\"0.006616771\",\"2\":\"0.008412490\",\"3\":\"0.002442701\",\"4\":\"0.024077662\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n<br/>\n\n#### Projecting risk\n\nWe now have the two ingredients that we need for risk analysis: excess weights and covariances of stock returns. As a final test, let's confirm that the order of the tickers in our vector matches that for our matrix.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncompare(\n  pull(data_weights, symbol), \n  colnames(return_covariances)\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nâœ” No differences\n```\n:::\n:::\n\n\nWith that confirmed, I can use the formula above to project the active variance of the portfolio.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(\n  variance_active_monthly <- t(data_weights$wt_excess) %*% return_covariances %*% data_weights$wt_excess\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n           [,1]\n[1,] 0.01163479\n```\n:::\n:::\n\n\nBecause I am considering covariances with a monthly periodicity, it will help to annualise the result, so that it can be compared with corresponding values from other portfolios. To do so, I multiply the active variance by 12.[^2] Finally, I square-root the result to obtain $\\omega$, the annualised level of projected active risk:\n\n[^2]: This might be a heroic assumption, as it implies an independence between the risks experienced in different months\n\n\n::: {.cell}\n\n```{.r .cell-code}\n(\n  risk_active_annual <- as.numeric(\n    sqrt(variance_active_monthly * 12)\n    )\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.3736543\n```\n:::\n:::\n\n\nThis annualised 'tracking-error' of 37.4% is very high for a US equity portfolio, but is not surprising given my arbitrary choices around the portfolio and index.\n\n<br/>\n\n#### Decomposing risk\n\nThe question then becomes: \"What portfolio positions contribute most to this active risk?\"\n\nTo answer this question, we can tweak the equation above. Calculating $X^T V$ generates a vector of length thirty, with each element showing a form of 'unit marginal impact' on active portfolio variance for a given stock. If we then multiply this value for a given stock by its excess weight, we obtain its contribution to monthly active portfolio variance.[^3]\n\n[^3]: Note that the sum of these values will add to the total active variance, as this calculation is essentially vector multiplication.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvariance_active_monthly_cont <- return_covariances %*% data_weights$wt_excess |> \n  as.data.frame() |> \n  rownames_to_column(var = \"symbol\") |> \n  inner_join(data_weights, by = \"symbol\") |> \n  mutate(AV_cont = wt_excess * V1) |> \n  select(symbol, company, sector, wt_excess, AV_cont)\n\nvariance_active_monthly_cont |> \n  select(symbol, sector, `AV contribution` = AV_cont)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"symbol\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"sector\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"AV contribution\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"AAPL\",\"2\":\"Information Technology\",\"3\":\"1.207239e-08\"},{\"1\":\"AMGN\",\"2\":\"Health Care\",\"3\":\"8.222219e-05\"},{\"1\":\"AXP\",\"2\":\"Financials\",\"3\":\"2.659503e-05\"},{\"1\":\"BA\",\"2\":\"Industrials\",\"3\":\"5.332634e-05\"},{\"1\":\"CAT\",\"2\":\"Industrials\",\"3\":\"-8.945410e-06\"},{\"1\":\"CRM\",\"2\":\"Information Technology\",\"3\":\"1.618290e-05\"},{\"1\":\"CSCO\",\"2\":\"Information Technology\",\"3\":\"4.650462e-04\"},{\"1\":\"CVX\",\"2\":\"Energy\",\"3\":\"-1.069517e-04\"},{\"1\":\"DIS\",\"2\":\"Communication Services\",\"3\":\"2.852764e-05\"},{\"1\":\"DOW\",\"2\":\"Materials\",\"3\":\"2.739671e-04\"},{\"1\":\"GS\",\"2\":\"Financials\",\"3\":\"4.253691e-03\"},{\"1\":\"HD\",\"2\":\"Consumer Discretionary\",\"3\":\"6.863872e-05\"},{\"1\":\"HON\",\"2\":\"Industrials\",\"3\":\"-4.457738e-05\"},{\"1\":\"IBM\",\"2\":\"Information Technology\",\"3\":\"9.140832e-05\"},{\"1\":\"INTC\",\"2\":\"Information Technology\",\"3\":\"4.415472e-04\"},{\"1\":\"JNJ\",\"2\":\"Health Care\",\"3\":\"-1.860266e-04\"},{\"1\":\"JPM\",\"2\":\"Financials\",\"3\":\"2.098915e-05\"},{\"1\":\"KO\",\"2\":\"Consumer Staples\",\"3\":\"3.137388e-04\"},{\"1\":\"MCD\",\"2\":\"Consumer Discretionary\",\"3\":\"1.931325e-03\"},{\"1\":\"MMM\",\"2\":\"Industrials\",\"3\":\"1.571341e-04\"},{\"1\":\"MRK\",\"2\":\"Health Care\",\"3\":\"6.612404e-05\"},{\"1\":\"MSFT\",\"2\":\"Information Technology\",\"3\":\"1.172040e-03\"},{\"1\":\"NKE\",\"2\":\"Consumer Discretionary\",\"3\":\"1.265359e-04\"},{\"1\":\"PG\",\"2\":\"Consumer Staples\",\"3\":\"-2.040067e-05\"},{\"1\":\"TRV\",\"2\":\"Financials\",\"3\":\"2.688150e-06\"},{\"1\":\"UNH\",\"2\":\"Health Care\",\"3\":\"2.533474e-03\"},{\"1\":\"V\",\"2\":\"Financials\",\"3\":\"-1.742568e-04\"},{\"1\":\"VZ\",\"2\":\"Communication Services\",\"3\":\"5.274462e-04\"},{\"1\":\"WBA\",\"2\":\"Consumer Staples\",\"3\":\"-1.866141e-04\"},{\"1\":\"WMT\",\"2\":\"Consumer Staples\",\"3\":\"-2.900952e-04\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n<br/>\n\nTo decompose this active variance by sector, we group stocks by sector and sum their stock-level contributions.\n\n\n::: {.cell preview='true'}\n\n```{.r .cell-code}\nvariance_active_monthly_cont |> \n  summarise(AV_total = sum(AV_cont), .by = sector) |> \n  mutate(\n    sector = as_factor(sector),\n    sector = fct_reorder(sector, AV_total)) |> \n  ggplot(\n    aes(\n      x = AV_total,\n      y = sector,\n      fill = AV_total < 0)) + \n  labs(\n    title = \"Contribution to active variance by sector\\n\",\n    x = NULL,\n    y = NULL) +\n  geom_col() + \n  theme_minimal() + \n  theme(\n    plot.title.position = \"plot\",\n    legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n<br/>\n\n#### Conclusions\n\nSo, what does this analysis tell us? To me, there are two main points:\n\n-   **The portfolio's tracking error is very high**, although that is an artefact of the simplified nature of my example\n\n-   **Financials stocks are a key contributor to this active variance**. This sector has high weights in the index but lower weights in the portfolio. However, the portfolio's positions in Energy and Consumer Staples stocks generates a diversification benefit that reduces overall portfolio risk.\n\nAlthough these results might be useful, it is worth recognising that I have limited this risk analysis to only a standard covariance matrix, decomposed by sector. In reality, the returns data and covariance matrix could be more nuanced and decomposition could extend beyond sectors. For example, we could decompose risk by ESG scores, diversity criteria, valuation ratios or anything else that seems relevant and that can be measured.\n\n<br/>\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}